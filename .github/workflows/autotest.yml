name: autotest
on:
  push:
    branches:
    - dev
  pull_request:
    branches:
    - dev
jobs:
  straka-2d:
    runs-on: [self-hosted, linux]
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by ${{runner.name}}"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workspace, ${{ github.workspace }}, is now ready to test your code on the runner."
      - name: patch code
        run : ./patch.py
      - name: configure problem
        run: ./configure.py $(head ./examples/2d.straka/straka.inp | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: run simulation
        run: ./bin/straka.ex -i ./examples/2d.straka/straka.inp
      - name: combile outputs
        run: ./combine.py -o test
      - name: compare result
        run: ./examples/2d.straka/test.py straka-test-main.nc ./examples/2d.straka/output.nc
      - name: clean up outputs
        run: rm -f combine_rules straka*
      - run: echo "${{ github.job }} case (single core) is a ${{ job.status }}"
  shallow-water:
    runs-on: [self-hosted, linux]
    needs: straka-2d
    env:
      MYDIR: ./examples/2d.shallow_water
      INPUT: shallow_water.inp
      EXE: ../../bin/shallow_water.ex
    steps:
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: run simulation
        run: cd $MYDIR && mpiexec -n 16 $EXE -i $INPUT
      - name: combile outputs
        run: cd $MYDIR && ../../combine.py -o test
      - name: compare result
        run: cd $MYDIR && ./test.py sw-test-main.nc output.nc
      - run: echo "${{ github.job }} case (parallel) is a ${{ job.status }}."
  polar-vortex: 
    runs-on: [self-hosted, linux]
    needs: shallow-water
    env:
      MYDIR: ./examples/2d.polar_vortex
      INPUT: fig_g_intruder.inp
      EXE: ../../bin/polar_vortex.ex
    steps:
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: make case folder
        run: mkdir -p $MYDIR/data
      - name: run simulation
        run: cd $MYDIR && mpiexec -n 16 $EXE -i $INPUT
      - name: combile outputs
        run: cd $MYDIR && ../../combine.py -d data -o test
      - name: compare result
        run: cd $MYDIR && ./test.py data/intruder-test-main.nc output.nc
      - run: echo "${{ github.job }} case is a ${{ job.status }}."
  robert-2d:
    runs-on: [self-hosted, linux]
    needs: straka-2d
    env:
      MYDIR: ./examples/3d.robert
      INPUT: robert2d.inp
      EXE: ../../bin/robert.ex
    steps:
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: run simulation
        run: cd $MYDIR && mpiexec -n 8 $EXE -i $INPUT
      - name: combile outputs
        run: cd $MYDIR && ../../combine.py -o test
      - name: compare result
        run: cd $MYDIR && ./test.py robert-test-main.nc output-2d.nc
      - run: echo "${{ github.job }} case (parallel, vertical decomposition) is a ${{ job.status }}."
  robert-3d:
    runs-on: [self-hosted, linux]
    needs: robert-2d
    env:
      MYDIR: ./examples/3d.robert
      INPUT: robert3d.inp
      EXE: ../../bin/robert.ex
    steps:
      - name: run simulation
        run: cd $MYDIR && mpiexec -n 32 $EXE -i $INPUT
      - name: combile outputs
        run: cd $MYDIR && ../../combine.py -o test
      - name: compare result
        run: cd $MYDIR && ./test.py robert-test-main.nc output-3d.nc
      - run: echo "${{ github.job }} case (parallel, vertical decomposition, 3d) is a ${{ job.status }}."
# radiation tests
  jupiter-juno: 
    runs-on: [self-hosted, linux]
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by ${{runner.name}}"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workspace, ${{ github.workspace }}, is now ready to test your code on the runner."
      - name: patch code
        run : ./patch.py jupiter_juno
      - name: configure problem
        run: ./configure.py $(head ./examples/1d.jupiter_juno/juno_mwr.tmp | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link run script
        run: ln -s ./run_scripts/run_radio.py ./
      - name: run simulation
        run: ./run_radio.py -i ./examples/1d.jupiter_juno/juno_mwr.tmp --exe ./bin/juno_mwr.ex -o test
      - name: compare result
        run: diff -I ^# juno_mwr-test.out ./examples/1d.jupiter_juno/juno_mwr.out
      - name: clean up outputs
        run: rm -f combine_rules juno_mwr-test* run_radio.py
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
  jupiter-juno-sampler:
    runs-on: [self-hosted, linux]
    needs: jupiter-juno
    env:
      MYDIR: ./examples/1d.jupiter_juno
      INPUT: juno_mwr.tmp
    steps:
      - name: patch code
        run : ./patch.py jupiter_juno
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link combine file
        run: ln -s ${{ github.workspace }}/combine.py $MYDIR/
      - name: link run script
        run: ln -s ${{ github.workspace }}/run_scripts/run_radio.py $MYDIR/
      - name: link plotting scripts
        run: ln -s ${{ github.workspace }}/run_scripts/plot_*.py $MYDIR/
      - name: run simulation
        run: cd $MYDIR && ./run_radio.py -i $INPUT --exe=../../bin/juno_mwr.ex --nwalker=10 --nlim=10 -o test
      - name: make mcmc plot
        run: cd $MYDIR && ./plot_mcmc.py -i juno_mwr-test
      - name: make ammonia plot
        run: cd $MYDIR && ./plot_ammonia.py -i juno_mwr-test
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
  jupiter-juno-inverter:
    runs-on: [self-hosted, linux]
    needs: jupiter-juno-sampler
    env:
      MYDIR: ./examples/1d.jupiter_juno
      INPUT: juno_mwr.tmp
      EXE: ../../bin/juno_mwr.ex
    steps:
      - name: patch code
        run : ./patch.py jupiter_juno
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-) -mpi
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link python scripts
        run: >
          ln -s ${{ github.workspace }}/run_scripts/prepare_radio_synthetic.py $MYDIR/
          ln -s ${{ github.workspace }}/run_scripts/create_input.py $MYDIR/
      - name: perturb ammonia concentration at 6 pressure levels
        run: >
          cd $MYDIR &&
          ./run_radio.py -M -i $INPUT --exe=$EXE --nh3="-0.1 -0.2 -0.3 -0.4 -0.3 -0.2" -o n6
      - name: prepare synthetic differential(d) observation
        run: >
          cd $MYDIR &&
          ./prepare_radio_synthetic.py -i juno_mwr-n6 -d
      - name: run nh3-inversion model at 6 pressure levels
        run: >
          cd $MYDIR &&
          ./create_input.py -i $INPUT --nwalker=12 --nodes=6 --nlim=250 -o n6p6 &&
          mpiexec -n 6 $EXE -i juno_mwr-n6p6.inp
      - name: combine outputs
        run: cd $MYDIR && ../../combine.py
      - name: make mcmc plot
        run: cd $MYDIR && ./plot_mcmc.py -i juno_mwr-n6p6
      - name: make ammonia plot
        run: cd $MYDIR && ./plot_ammonia.py -i juno_mwr-n6p6 --truth=juno_mwr-n6
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
  saturn-vla: 
    runs-on: [self-hosted, linux]
    needs: jupiter-juno
    steps:
      - name: patch code
        run : ./patch.py saturn_vla
      - name: configure problem
        run: ./configure.py $(head ./examples/1d.saturn_vla/vla_saturn.tmp | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link run script
        run: ln -s ./run_scripts/run_radio.py ./
      - name: run simulation
        run: ./run_radio.py -i ./examples/1d.saturn_vla/vla_saturn.tmp --exe ./bin/saturn_vla.ex -o test
      - name: compare result
        run: diff -I ^# vla_saturn-test.out ./examples/1d.saturn_vla/vla_saturn.out
      - name: finalize
        run: rm -f combine_rules run_radio.py vla_saturn-test*
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
  saturn-vla-sampler:
    runs-on: [self-hosted, linux]
    needs: saturn-vla
    env:
      MYDIR: ./examples/1d.saturn_vla
      INPUT: vla_saturn.tmp
    steps:
      - name: patch code
        run : ./patch.py saturn_vla
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link combine file
        run: ln -s ${{ github.workspace }}/combine.py $MYDIR/
      - name: link run script
        run: ln -s ${{ github.workspace }}/run_scripts/run_radio.py $MYDIR/
      - name: link plotting scripts
        run: ln -s ${{ github.workspace }}/run_scripts/plot_*.py $MYDIR/
      - name: run simulation
        run: cd $MYDIR && ./run_radio.py -i $INPUT --exe=../../bin/saturn_vla.ex --nwalker=10 --nlim=10 -o test
      - name: make mcmc plot
        run: cd $MYDIR && ./plot_mcmc.py -i vla_saturn-test
      - name: make ammonia plot
        run: cd $MYDIR && ./plot_ammonia.py -i vla_saturn-test
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
  saturn-vla-inverter:
    runs-on: [self-hosted, linux]
    needs: saturn-vla-sampler
    env:
      MYDIR: ./examples/1d.saturn_vla
      INPUT: vla_saturn.tmp
      EXE: ../../bin/saturn_vla.ex
    steps:
      - name: patch code
        run : ./patch.py saturn_vla
      - name: configure problem
        run: ./configure.py $(head $MYDIR/$INPUT | grep configure | cut -d ' ' -f3-)
      - name: clean up libraries
        run: make clean
      - name: compile code
        run: make -j4
      - name: link python scripts
        run: >
          ln -s ${{ github.workspace }}/run_scripts/prepare_radio_synthetic.py $MYDIR/
          ln -s ${{ github.workspace }}/run_scripts/create_input.py $MYDIR/
      - name: perturb ammonia concentration at 6 pressure levels
        run: >
          cd $MYDIR &&
          ./run_radio.py -M -i $INPUT --exe=$EXE --plevel=50:0.5:6 --nh3="-0.1 -0.2 -0.3 -0.4 -0.3 -0.2" -o n6
      - name: prepare synthetic differential(d) observation
        run: >
          cd $MYDIR &&
          ./prepare_radio_synthetic.py -i vla_saturn-n6 -d
      - name: run nh3-inversion model at 8 pressure levels
        run: >
          cd $MYDIR &&
          ./create_input.py -i $INPUT --nwalker=16 --nodes=8 --nlim=250 -o n6p8 &&
          mpiexec -n 8 $EXE -i vla_saturn-n6p8.inp
      - name: combine outputs
        run: cd $MYDIR && ../../combine.py
      - name: make mcmc plot
        run: cd $MYDIR && ./plot_mcmc.py -i vla_saturn-n6p8
      - name: make ammonia plot
        run: cd $MYDIR && ./plot_ammonia.py -i vla_saturn-n6p8 --truth=vla_saturn-n6
      - run: echo "${{ github.job }} case is a ${{ job.status }}"
